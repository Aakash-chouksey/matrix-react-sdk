name: Unit test coverage
on:
    pull_request:
        branches: [develop]
jobs:
    build:
        runs-on: ubuntu-latest
        env:
          PR_NUMBER: ${{github.event.number}}
        steps:
            - uses: actions/checkout@v2
              with:
                # good enough depth to get common ancestor bw pr and develop
                fetch-depth: 1000
            # fetch develop branch for jest changedSince compare
            - name: Get develop branch 
              run: |
                git fetch --no-tags origin develop
            - uses: c-hive/gha-yarn-cache@v2
            - name: Install Deps
              run: "./scripts/ci/install-deps.sh --ignore-scripts"
            - name: Generate coverage for changes
              run: |
                yarn reskindex
                yarn test --silent --coverage --changedSince=origin/develop --coverage-reporters="text" > coverage-report.txt
            - name: Report coverage
              uses: actions/github-script@v6
              with:
                script: |
                  const fs = require('fs/promises');
                  const content = await fs.readFile('coverage-report.txt', 'utf8');
                  github.rest.issues.createComment({
                    issue_number: context.issue.number,
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    body: content
                  })

